<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Project Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --vs-background: #1e1e1e;
            --vs-editor-background: #007acc;
            --vs-container-background: #252526;
            --vs-text-color: #d4d4d4;
            --vs-accent-blue: #569cd6;
            --vs-border-color: #3c3c3c;
            --vs-input-background: #3c3c3c;
            --vs-input-border: #555;
            --vs-button-background: #007acc;
            --vs-button-hover: #005a9e;
            --vs-green: #4CAF50;
            --vs-red: #f44336;
            --vs-blue: #2196F3;
            --vs-light: #f5f5f5;
            --vs-selection: #264F78;
        }

        body {
            background-color: var(--vs-background);
            color: var(--vs-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .container {
            background-color: var(--vs-container-background);
            border-radius: 0.5rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-width: 1200px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stock-low {
            color: var(--vs-red);
            font-weight: 600;
        }

        .stock-medium {
            color: #FFA500; /* Orange for medium */
            font-weight: 600;
        }

        .stock-good {
            color: var(--vs-green);
            font-weight: 600;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--vs-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto bg-gray-800 bg-opacity-90 p-6 rounded-lg shadow-lg shadow-gray-700/10 mt-10">
        <h1 class="text-blue-400 text-3xl font-bold mb-4">Dashboard</h1>
        <p class="text-gray-100">Welcome, {{ current_user.username }}!</p>
        <p class="text-gray-100">You are logged in as: {{ current_user.role }}</p>

        <!-- Material Requests Notifications (Admin Only) -->
        {% if current_user.role == 'admin' and material_requests %}
        <div class="bg-yellow-900 border border-yellow-700 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold text-yellow-300 mb-4">üîî Material Requests ({{ material_requests|length }})</h2>
            
            <div class="space-y-3">
                {% for request in material_requests %}
                <div class="bg-yellow-800 p-3 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-white">{{ request.project_name }}</h4>
                            <p class="text-yellow-200 text-sm">Requested by: {{ request.requester_name }}</p>
                            <p class="text-yellow-200 text-sm">Date: {{ request.date }}</p>
                            
                            {% if request.materials_needed %}
                            {% set materials = request.materials_needed %}
                            <div class="mt-2 text-yellow-100 text-sm">
                                <strong>{{ materials.material_name if materials is mapping else 'Material' }}</strong>: 
                                {{ materials.quantity if materials is mapping else 'N/A' }} 
                                {{ materials.unit if materials is mapping else '' }} 
                                ({{ materials.priority if materials is mapping else 'Unknown' }} priority)
                            </div>
                            {% if materials.notes %}
                            <p class="text-yellow-200 text-sm mt-1">Notes: {{ materials.notes }}</p>
                            {% endif %}
                            {% endif %}
                        </div>
                        
                        <div class="flex space-x-2">
                            <form action="{{ url_for('approve_materials', event_id=request.id) }}" method="POST">
                                <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm">
                                    ‚úÖ Approve
                                </button>
                            </form>
                            <form action="{{ url_for('reject_materials', event_id=request.id) }}" method="POST">
                                <button type="submit" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">
                                    ‚ùå Reject
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <a href="{{ url_for('project_tracking') }}" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center relative">
                <div class="text-2xl mb-2">üìù</div>
                <h3 class="font-semibold">Project Activity</h3>
            </a>

            <a href="{{ url_for('project_reports') }}" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center relative">
                <div class="text-2xl mb-2">üìä</div>
                <h3 class="font-semibold">Project Reports</h3>
            </a>

            <a href="{{ url_for('materials') }}" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center relative">
                <div class="text-2xl mb-2">üì¶</div>
                <h3 class="font-semibold">Materials</h3>
                {% if current_user.role == 'admin' and material_requests %}
                <span class="notification-badge">{{ material_requests|length }}</span>
                {% endif %}
            </a>

            <a href="{{ url_for('production_calendar') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-lg text-center">
                <div class="text-2xl mb-2">üóìÔ∏è</div>
                <h3 class="font-semibold">Calendar</h3>
            </a>
        </div>

        <!-- Admin Tools Section -->
        {% if current_user.role == 'admin' %}
        <div class="bg-gray-700 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">üõ†Ô∏è Admin Tools</h2>
            <div class="flex flex-wrap gap-4">
                <a href="{{ url_for('report') }}" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">
                    üìà Reports
                </a>
                <a href="{{ url_for('food_cost_calculator') }}" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">
                    üí∞ Cost Calculator
                </a>
                <a href="{{ url_for('purchase_orders') }}" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">
                    üìã Material Orders
                </a>
                <a href="{{ url_for('projects_management') }}" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">
                    üèóÔ∏è Project Management
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Materials Overview Section -->
        {% if current_user.role == 'admin' and materials_by_project %}
        <div class="bg-gray-700 p-4 rounded-lg mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">üì¶ Materials Overview</h2>
                <a href="{{ url_for('materials') }}" class="text-blue-400 hover:text-blue-300 text-sm">
                    Manage All Materials ‚Üí
                </a>
            </div>
            <select name="project_id" id="project_id" required>
    <option value="">-- Select Project --</option>
    <!-- Projects will be populated by JavaScript -->
</select>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for project, materials in materials_by_project.items() %}
                <div class="bg-gray-600 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-3">
                        {% if project == 'General Stock' %}
                        üè† {{ project }}
                        {% else %}
                        üèóÔ∏è {{ project }}
                        {% endif %}
                    </h3>

                    {% if project != 'General Stock' and project_progress[project] is defined %}
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-300">Progress</span>
                            <span class="text-sm font-semibold">{{ project_progress[project]|round|int }}%</span>
                        </div>
                        <div class="w-full bg-gray-500 rounded-full h-2.5">
                            <div class="bg-blue-400 h-2.5 rounded-full progress-bar" 
                                 style="width: {{ project_progress[project] }}%"></div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="space-y-2">
                        {% for material in materials[:3] %}
                        <div class="flex justify-between items-center text-sm">
                            <span class="truncate">{{ material.material_name if material is mapping else material[0] }}</span>
                            <span class="{% if (material.quantity_in_stock if material is mapping else material[4]) <= (material.minimum_stock_level if material is mapping else material[5]) %}stock-low
                                       {% elif (material.quantity_in_stock if material is mapping else material[4]) <= (material.minimum_stock_level if material is mapping else material[5]) * 2 %}stock-medium
                                       {% else %}stock-good{% endif %}">
                                {{ material.quantity_in_stock if material is mapping else material[4] }}/{{ material.minimum_stock_level if material is mapping else material[5] }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-500">
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>{{ materials|length }} items</span>
                            {% set low_stock_count = 0 %}
                            {% for material in materials %}
                                {% if (material.quantity_in_stock if material is mapping else material[4]) <= (material.minimum_stock_level if material is mapping else material[5]) %}
                                    {% set low_stock_count = low_stock_count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% if low_stock_count > 0 %}
                            <span class="stock-low">{{ low_stock_count }} need reorder</span>
                            {% else %}
                            <span class="stock-good">Stocked</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif current_user.role == 'admin' %}
        <div class="bg-gray-700 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">üì¶ Materials Overview</h2>
            <div class="text-gray-400 text-center p-4">
                No materials data available. 
                <a href="{{ url_for('materials') }}" class="text-blue-400 hover:text-blue-300">
                    Add some materials to get started.
                </a>
            </div>
        </div>
        {% endif %}

       <!-- Time Tracking Section -->
<div class="bg-gray-700 p-4 rounded-lg mb-6">
    <h2 class="text-xl font-semibold text-white mb-4">‚è∞ Time Tracking</h2>
    
    <div class="flex flex-col sm:flex-row gap-4">
        {% if current_record %}
<!-- Punch Out Link -->
<a href="{{ url_for('punch_out_with_location') }}" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-semibold text-center">
    üìç Project Out
</a>
{% else %}
<!-- Punch In Link -->
<a href="{{ url_for('punch_with_location_page') }}" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-semibold text-center">
    üìç Project Start
</a>
{% endif %}
        
  

    {% if current_record %}
    <div class="mt-4 p-3 bg-blue-900 rounded">
        <p class="text-blue-200 text-sm">‚úÖ Project Started</p>
        {% if current_record.latitude and current_record.longitude %}

        {% endif %}
    </div>
    {% endif %}
</div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="space-y-2">
            {% for category, message in messages %}
            <div class="p-3 rounded 
                {% if category == 'success' %}bg-green-900 text-green-200
                {% elif category == 'danger' %}bg-red-900 text-red-200
                {% elif category == 'warning' %}bg-yellow-900 text-yellow-200
                {% else %}bg-blue-900 text-blue-200{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
    </div>

    <!-- Project Modal -->
    <div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-gray-800 text-gray-100">
                <div class="modal-header border-gray-700">
                    <h5 class="modal-title text-xl font-bold">Project Work Report</h5>
                    <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="punchOutForm" method="POST" action="{{ url_for('punch_out') }}" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="block text-gray-400 mb-1">Project</label>
                            <select class="form-select bg-gray-700 text-gray-100 border-gray-600" name="project_name" required>
                                <option value="">Select Project</option>
                                <option value="Rosyln">Rosyln</option>
                                <option value="Sabin">Sabin</option>
                                <option value="Ceasars">Ceasars</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-gray-400 mb-1">Task Description</label>
                            <textarea class="form-control bg-gray-700 text-gray-100 border-gray-600" name="task_description" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-gray-400 mb-1">Progress Notes</label>
                            <textarea class="form-control bg-gray-700 text-gray-100 border-gray-600" name="progress_notes" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-gray-400 mb-1">Progress Photo</label>
                            <input type="file" class="form-control bg-gray-700 text-gray-100 border-gray-600" name="progress_photo" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-gray-700">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="punchOutForm" class="btn btn-primary">Submit Punch Out</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    function showProjectModal() {
        fetch('/check_punch_status')
            .then(response => response.json())
            .then(data => {
                if (!data.is_punched_in) {
                    alert('You are not punched in!');
                    return;
                }
                
                document.getElementById('punchOutForm').reset();
                new bootstrap.Modal(document.getElementById('projectModal')).show();
            });
    }
    </script>
</body>
</html>